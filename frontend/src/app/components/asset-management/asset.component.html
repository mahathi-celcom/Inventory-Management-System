<!-- ✅ Asset Management with Layout Component - Redesigned -->
<app-layout 
  pageTitle="Manage and track your IT assets with real-time insights"
  [navigationItems]="navigationItems"
  (navigationClick)="onNavigationClick($event)">
  
  <!-- Header Actions -->
  <div slot="header-actions" class="flex flex-wrap items-center gap-3">
    <div class="flex items-center space-x-2 px-4 py-2 bg-gray-100 rounded-xl">
      <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
      <span class="text-sm font-medium text-gray-800">{{ totalAssets() }} Total Assets</span>
    </div>
    
    @if (hasSelectedAssets()) {
      <button
        type="button"
        (click)="bulkDeleteSelected()"
        class="inline-flex items-center px-5 py-2.5 bg-red-600 text-white font-medium rounded-xl hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-200 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
        </svg>
        DELETE SELECTED ({{ selectedCount() }})
      </button>
    }
    
    <button
      type="button"
      (click)="openAddAssetModal()"
      class="inline-flex items-center px-6 py-2.5 bg-celcom-primary text-white font-medium rounded-xl hover:bg-celcom-secondary focus:outline-none focus:ring-4 focus:ring-blue-200 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
      </svg>
      ADD NEW ASSET
    </button>
  </div>

  <!-- Main Content -->
  <div class="space-y-6">
    <!-- Summary and Filters Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Summary Card -->
      <div class="lg:col-span-1">
        <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-semibold mb-2 text-gray-800">Total Assets</h3>
              <p class="text-3xl font-bold text-gray-900">{{ totalAssets() }}</p>
    </div>
            <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            </div>
          </div>
          <div class="mt-4 flex items-center justify-between text-sm">
            <div class="flex items-center">
              <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
              <span class="text-gray-700">Active: {{ getActiveAssetCount() }}</span>
            </div>
            <div class="flex items-center">
              <div class="w-2 h-2 bg-red-500 rounded-full mr-2"></div>
              <span class="text-gray-700">Inactive: {{ getInactiveAssetCount() }}</span>
            </div>
          </div>
          </div>
        </div>

      <!-- Filters Card -->
      <div class="lg:col-span-2">
        <div class="bg-white border border-gray-200 rounded-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
              <div class="p-2 rounded-lg bg-gray-100">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-gray-800 ml-3">Filters</h3>
            </div>
            <button 
              type="button"
              (click)="clearFilters()"
              class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors px-3 py-1 rounded-md hover:bg-blue-100">
              Clear All
            </button>
            </div>

          <!-- ✅ CLIENT-SIDE FILTER FORM -->
          <form [formGroup]="clientFilterForm" class="space-y-4">
            <!-- ✅ CLIENT-SIDE FILTER GRID -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Quick Search -->
              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Quick Search</label>
                <input
                  type="text"
                  formControlName="search"
                  placeholder="Search assets..."
                  class="block w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500 transition-all duration-200 bg-white">
          </div>

              <!-- Asset Status Filter -->
              <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-2">Asset Status</label>
            <select 
                  formControlName="status"
                  class="block w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-gray-500 transition-all duration-200 bg-white">
                  <option value="">All Statuses</option>
                  @for (status of dropdownOptions().statuses; track status.value) {
                    <option [value]="status.value">{{ status.label }}</option>
              }
            </select>
              </div>
            </div>
          </form>
        </div>
      </div>
          </div>

    <!-- ✅ CLIENT-SIDE FILTER ACTIONS -->
    <div class="bg-white rounded-xl p-6 shadow-lg mt-6">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <!-- Active Filters Summary -->
        @if (hasActiveFilters()) {
          <div class="flex items-center space-x-2">
            <div class="px-3 py-1.5 bg-celcom-orange/20 text-celcom-orange rounded-full text-sm font-medium border border-celcom-orange/30">
              <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707v4.586a1 1 0 01-.293.707L9 20.414A1 1 0 018 19.707V14.414a1 1 0 00-.293-.707L1.293 7.293A1 1 0 011 6.586V4z"></path>
              </svg>
              {{ filterSummary() }}
          </div>
            <span class="text-sm text-gray-600">{{ totalAssets() }} assets found</span>
          </div>
        } @else {
          <div class="text-sm text-gray-600">
            Showing all {{ totalAssets() }} assets
          </div>
        }

        <!-- Filter Actions -->
        <div class="flex items-center space-x-3">
          <!-- Clear Filters Button -->
            <button
              type="button"
              (click)="clearFilters()"
            [disabled]="!hasActiveFilters()"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-celcom-orange focus:ring-offset-2 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Clear Filters
          </button>

          <!-- Refresh Data Button -->
          <button 
            type="button"
            (click)="refreshData()"
            [disabled]="clientSideLoading()"
            class="px-4 py-2 text-sm font-medium text-white bg-celcom-primary border border-transparent rounded-lg hover:bg-celcom-secondary focus:outline-none focus:ring-2 focus:ring-celcom-orange focus:ring-offset-2 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
            @if (clientSideLoading()) {
              Loading...
            } @else {
              Refresh Data
            }
            </button>
          </div>
        </div>

      <!-- ✅ NEW: Filter Summary Display -->
      @if (hasActiveFilters()) {
        <div class="mt-4 p-3 bg-celcom-orange/10 border border-celcom-orange/30 rounded-lg">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
              <svg class="w-4 h-4 text-celcom-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.414A1 1 0 013 6.707V4z"></path>
              </svg>
              <span class="text-sm font-medium text-celcom-orange">Active Filters:</span>
    </div>
            <button
              type="button"
              (click)="clearFilters()"
              class="text-xs text-celcom-orange hover:text-celcom-purple font-medium">
              Clear All
            </button>
          </div>
          <p class="text-sm text-celcom-purple mt-1">{{ getFilterSummary() }}</p>
        </div>
      }
  </div>

    <!-- ✅ Compact Horizontal Table -->
  <div class="bg-white rounded-lg shadow-md border border-gray-200">
      
      <!-- ✅ NEW: Pagination Info Header -->
      <div class="bg-celcom-orange/10 px-6 py-4 border-b border-celcom-orange/20">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
              <svg class="w-5 h-5 text-celcom-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              <span class="text-sm font-semibold text-gray-800">Asset Inventory</span>
            </div>
            
            <div class="text-sm text-gray-600">
              <span class="font-medium">{{ totalAssets() }}</span> total assets
              @if (hasActiveFilters()) {
                <span class="text-celcom-orange ml-1">(filtered)</span>
              }
            </div>
          </div>
          
          <!-- Pagination Info -->
          <div class="flex items-center space-x-4 text-sm text-gray-600">
            <div class="flex items-center space-x-2">
              <span>Page {{ currentPage() + 1 }} of {{ Math.ceil(totalAssets() / pageSize()) || 1 }}</span>
              <span class="text-gray-400">•</span>
              <span>{{ pageSize() }} per page</span>
            </div>
            
            @if (paginatedAssets().length > 0) {
              <div class="flex items-center space-x-2">
                <span class="text-gray-400">•</span>
                <span>Showing {{ (currentPage() * pageSize()) + 1 }}-{{ Math.min((currentPage() + 1) * pageSize(), totalAssets()) }}</span>
              </div>
            }
          </div>
        </div>
      </div>

    <!-- Loading State -->
    @if (loading()) {
      <div class="flex items-center justify-center py-20">
        <div class="text-center space-y-4">
          <div class="relative">
            <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto"></div>
            <div class="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin absolute top-2 left-1/2 transform -translate-x-1/2 animate-pulse"></div>
          </div>
          <p class="text-gray-800 font-medium">Loading your assets...</p>
            @if (hasActiveFilters()) {
              <p class="text-sm text-celcom-orange">Applying filters...</p>
            }
        </div>
      </div>
    }

      <!-- Enhanced Compact Table View -->
      @if (!clientSideLoading() && paginatedAssets().length > 0) {
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gradient-to-r from-celcom-primary/10 to-celcom-secondary/10">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-celcom-primary/20 transition-colors">
                  <mat-checkbox
                    [checked]="isAllSelected()"
                    [indeterminate]="hasSelectedAssets() && !isAllSelected()"
                    (change)="masterToggle()"
                    class="text-celcom-orange">
                  </mat-checkbox>
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-celcom-primary/20 transition-colors">S.No</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-celcom-primary/20 transition-colors">Asset Details</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-celcom-primary/20 transition-colors">Model</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-celcom-primary/20 transition-colors">OS Version</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-celcom-primary/20 transition-colors">PO Number</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-celcom-primary/20 transition-colors">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-celcom-primary/20 transition-colors">Warranty/License</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-celcom-primary/20 transition-colors">Assignment</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-celcom-primary/20 transition-colors">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              @for (asset of paginatedAssets(); track asset.assetId; let i = $index) {
                <tr class="hover:bg-gradient-to-r hover:from-celcom-primary/5 hover:to-celcom-secondary/5 transition-all duration-200">
                  <!-- Selection Checkbox -->
                  <td class="px-6 py-4">
                    <mat-checkbox 
                      [checked]="selection.isSelected(asset)" 
                      (change)="selection.toggle(asset)"
                      class="text-celcom-orange">
                    </mat-checkbox>
                  </td>
                  
                  <!-- Serial Number -->
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    {{ i + 1 }}
                  </td>
                  
                  <!-- Asset Details -->
                  <td class="px-6 py-4">
                    <div class="min-w-0 flex-1">
                      <div class="text-sm font-semibold text-gray-900 truncate">{{ asset.name }}</div>
                      <div class="text-xs text-gray-500">Serial Number: {{ asset.serialNumber }}</div>
                      @if (asset.itAssetCode) {
                        <div class="text-xs text-blue-600 font-medium">IT Asset Code: {{ asset.itAssetCode }}</div>
                      }
                    </div>
                  </td>

                  <!-- Model -->
                  <td class="px-6 py-4">
                    <div class="text-sm">
                      <div class="font-medium text-gray-900">{{ getModelName(asset.modelId) }}</div>
                      <div class="text-xs text-gray-500">(Type: {{ getAssetTypeName(asset.typeId) }}, Make: {{ getMakeName(asset.makeId) }})</div>
                    </div>
                  </td>

                  <!-- OS Version -->
                  <td class="px-6 py-4">
                    <div class="text-sm">
                      @if (asset.osVersionId) {
                        <div class="font-medium text-gray-900">{{ getOSVersionName(asset.osVersionId) }}</div>
                        <div class="text-xs text-gray-500">({{ getOSName(asset.osId) }})</div>
                      } @else {
                        <span class="text-gray-400">Not specified</span>
                      }
                    </div>
                  </td>

                  <!-- PO Number (Clickable Button to Open Modal) -->
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-2">
                      <button
                        (click)="openPOSelectionModal(asset)"
                        class="text-xs border border-gray-300 rounded px-3 py-2 bg-white hover:bg-gray-50 focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-all duration-200 max-w-32 text-left">
                        {{ asset.poNumber || 'Select PO' }}
                      </button>
                      @if (asset.poNumber) {
                        <button
                          (click)="showPODetails(asset.poNumber)"
                          class="p-1 text-blue-600 hover:text-blue-800 hover:bg-blue-100 rounded transition-all duration-200"
                          matTooltip="View PO Details">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                          </svg>
                        </button>
                      }
                        </div>
                  </td>

                  <!-- Status with Enhanced Color Coding -->
                  <td class="px-6 py-4">
                    <div class="space-y-2">
                      <div [class]="getStatusColorClass(asset.status)" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                        <span class="mr-1">{{ getStatusBadge(asset.status).icon }}</span>
                        {{ getStatusBadge(asset.status).label }}
                      </div>
                      <div class="flex items-center gap-2">
                        <select 
                          [value]="asset.status"
                          (change)="onAssetStatusChange(asset, $any($event.target).value)"
                          [disabled]="statusChangeLoading()"
                          class="text-xs border border-gray-300 rounded px-2 py-1 bg-white hover:bg-gray-50 focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-all duration-200 max-w-24 disabled:opacity-50 disabled:cursor-not-allowed">
                          @for (option of statusDropdownOptions(); track option.value) {
                            <option [value]="option.value" [selected]="asset.status === option.value">{{ option.label }}</option>
                          }
                        </select>
                        <button
                          (click)="openStatusHistoryModal(asset)"
                          class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200 transition-colors duration-200">
                          History
                        </button>
                      </div>
                    </div>
                  </td>

                  <!-- Warranty/License Status -->
                  <td class="px-6 py-4">
                    <div class="space-y-1">
                      @if (isHardwareOrPeripheralAsset(asset)) {
                        <div class="flex items-center">
                          <span class="text-xs font-medium text-gray-600 mr-2">Warranty:</span>
                          <span [class]="getWarrantyBadgeClass(asset)" class="px-2 py-1 rounded-full text-xs font-medium">
                            {{ getWarrantyStatusDisplay(asset) }}
                          </span>
                        </div>
                        @if (asset.warrantyExpiry) {
                          <div class="text-xs text-gray-500">Expires: {{ asset.warrantyExpiry | date:'dd/MM/yyyy' }}</div>
                        }
                      }
                      @if (isSoftwareAsset(asset)) {
                        <div class="flex items-center">
                          <span class="text-xs font-medium text-gray-600 mr-2">License:</span>
                          <span [class]="getLicenseBadgeClass(asset)" class="px-2 py-1 rounded-full text-xs font-medium">
                            {{ getLicenseStatusDisplay(asset) }}
                          </span>
                        </div>
                        @if (asset.licenseValidityPeriod) {
                          <div class="text-xs text-gray-500">Expires: {{ asset.licenseValidityPeriod | date:'dd/MM/yyyy' }}</div>
                        }

                      }
                      @if (!asset.assetCategory) {
                        <div class="text-xs text-gray-400">Category not set</div>
                      }
                    </div>
                  </td>

                  <!-- Assignment with Enhanced History Button -->
                  <td class="px-6 py-4">
                    <div class="space-y-2">
                      @if (asset.currentUserId) {
                        <div class="text-xs font-medium text-gray-900">{{ getUserName(asset.currentUserId) }}</div>
                        <div class="text-xs text-green-600">Assigned</div>
                      } @else {
                        <div class="text-xs text-gray-500">Unassigned</div>
                      }
                      <div>
                      <button
                          (click)="openAssignmentHistoryModal(asset)"
                          class="text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded hover:bg-purple-200 transition-colors duration-200">
                        History
                      </button>
                      </div>
                    </div>
                  </td>

                  <!-- Actions -->
                  <td class="px-6 py-4">
                    <div class="flex items-center space-x-1">
                      <button
                        (click)="openEditAssetModal(asset)"
                        class="p-1.5 text-celcom-primary hover:text-celcom-secondary transition-colors duration-200"
                        matTooltip="Edit Asset">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                      </button>
                      <button
                        (click)="openUserAssignmentModal(asset)"
                        [disabled]="!isAssignmentAllowedForStatus(asset.status) || userAssignmentLoading()"
                        [class]="isAssignmentAllowedForStatus(asset.status) && !userAssignmentLoading() ? 'p-1.5 text-green-600 hover:text-green-800 transition-colors duration-200' : 'p-1.5 text-gray-400 cursor-not-allowed'"
                        [matTooltip]="getAssignmentTooltip(asset)">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                      </button>
                      <button
                        (click)="downloadAssetDetails(asset)"
                        class="p-1.5 text-celcom-primary hover:text-celcom-secondary transition-colors duration-200"
                        matTooltip="Download Details">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path>
                        </svg>
                      </button>
                      <button
                        (click)="deleteAsset(asset)"
                        class="p-1.5 text-red-600 hover:text-red-800 transition-colors duration-200"
                        matTooltip="Delete Asset">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
      </div>

        <!-- ✅ NEW: Enhanced Pagination Controls -->
        @if (totalAssets() > pageSize()) {
          <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
            <div class="flex flex-wrap items-center justify-between gap-4">
              <!-- Page Info -->
              <div class="flex items-center space-x-2 text-sm text-gray-600">
                <span>Showing {{ (currentPage() * pageSize()) + 1 }}-{{ Math.min((currentPage() + 1) * pageSize(), totalAssets()) }} of {{ totalAssets() }} assets</span>
                </div>
                
              <!-- Pagination Controls -->
                  <div class="flex items-center space-x-2">
                <!-- Previous Page -->
                  <button
                    type="button"
                  (click)="goToPreviousPage()"
                  [disabled]="!hasPreviousPage()"
                  class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-white transition-colors">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                  </button>
                  
                <!-- Page Numbers -->
                @for (page of [].constructor(getTotalPages()); track $index) {
                  @if ($index === currentPage()) {
                  <button
                    type="button"
                      class="px-3 py-2 text-sm font-semibold text-white bg-gradient-to-r from-celcom-orange to-celcom-purple border border-celcom-orange rounded-lg">
                      {{ $index + 1 }}
                  </button>
                  } @else if ($index <= currentPage() + 2 && $index >= currentPage() - 2) {
                  <button
                    type="button"
                      (click)="goToPage($index)"
                      class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                      {{ $index + 1 }}
                  </button>
                  } @else if ($index === 0 || $index === getTotalPages() - 1) {
                    <button
                      type="button"
                      (click)="goToPage($index)"
                      class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                      {{ $index + 1 }}
                    </button>
                  } @else if ($index === currentPage() - 3 || $index === currentPage() + 3) {
                    <span class="px-2 py-2 text-sm text-gray-500">...</span>
                  }
                }
                
                <!-- Next Page -->
                    <button
                  type="button"
                  (click)="goToNextPage()"
                  [disabled]="!hasNextPage()"
                  class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-white transition-colors">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                      </svg>
                    </button>
                  </div>
              
              <!-- Page Size Selector -->
              <div class="flex items-center space-x-2 text-sm">
                <label class="text-gray-600">Show:</label>
                <select
                  [value]="pageSize()"
                  (change)="onPageChange({pageIndex: 0, pageSize: +$any($event.target).value, length: totalAssets()})"
                  class="px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange">
                  <option value="5">5</option>
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
                <span class="text-gray-600">per page</span>
              </div>
            </div>
          </div>
        }
      }

      <!-- No Results State -->
      @if (!clientSideLoading() && filteredAssets().length === 0) {
        <div class="flex flex-col items-center justify-center py-20">
          <div class="text-center space-y-4">
            <svg class="w-16 h-16 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 009.586 13H7"></path>
          </svg>
            <div>
              <h3 class="text-lg font-medium text-gray-900">No assets found</h3>
              <p class="text-gray-500">Try adjusting your search criteria or filters.</p>
        </div>
        <button
          type="button"
              (click)="clearFilters()"
              class="inline-flex items-center px-4 py-2 bg-celcom-orange text-white font-medium rounded-lg hover:bg-celcom-purple transition-colors duration-200">
              Clear Filters
        </button>
          </div>
      </div>
    }
  </div>
</div>

  <!-- ✅ Enhanced Asset Form Modal with Better UX -->
@if (isFormModalOpen()) {
    <div class="fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4" (click)="closeAssetModal()">
      <div class="relative w-full max-w-4xl max-h-[90vh] shadow-2xl rounded-lg bg-white overflow-hidden" (click)="$event.stopPropagation()">
        
        <!-- Modal Header -->
        <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 z-10">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-celcom-orange rounded-full flex items-center justify-center">
                  @if (isEditMode()) {
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                  } @else {
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                  }
                </div>
              </div>
              <div>
                <h3 class="text-xl font-semibold text-gray-900">
                  {{ isEditMode() ? 'Edit Asset' : 'Create New Asset' }}
              </h3>
                <p class="text-sm text-gray-500">
                  {{ isEditMode() ? 'Update asset information' : 'Add a new asset to the inventory' }}
                </p>
              </div>
            </div>
            <button (click)="closeAssetModal()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-colors duration-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
          </div>
          </div>

        <!-- Form Progress Indicator -->
        <div class="px-6 py-3 bg-gray-50 border-b border-gray-200">
          <div class="flex items-center justify-between text-sm">
            <span class="text-gray-600">Complete the required fields to create the asset</span>
            <div class="flex items-center space-x-2">
              <div class="flex items-center space-x-1">
                @if (assetForm.valid) {
                  <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                  </svg>
                  <span class="text-green-600 font-medium">Form Valid</span>
                } @else {
                  <svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                  </svg>
                  <span class="text-amber-600 font-medium">Complete Required Fields</span>
                }
              </div>
              <!-- Debug Button for Development -->
              <button 
                type="button" 
                (click)="debugFormState()" 
                class="ml-2 px-2 py-1 text-xs text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors"
                title="Debug form state (development only)">
                🔍 Debug
              </button>
            </div>
          </div>
        </div>

        <!-- Form Content -->
        <div class="overflow-y-auto max-h-[calc(90vh-200px)]">
          <form [formGroup]="assetForm" (ngSubmit)="onSubmitAsset()" novalidate>
            <div class="px-6 py-6 space-y-8">
              
              <!-- Step 1: Basic Information -->
              <div class="space-y-6">
                <div class="flex items-center space-x-3 pb-3 border-b border-gray-200">
                  <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                    <span class="text-sm font-medium text-blue-600">1</span>
                  </div>
                  <div>
                    <h4 class="text-lg font-medium text-gray-900">Basic Information</h4>
                    <p class="text-sm text-gray-500">Essential asset details</p>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- Asset Name -->
                  <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                      Asset Name
                      <span class="text-red-500 ml-1">*</span>
                      <div class="ml-2 group relative">
                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap">
                          Enter a descriptive name for the asset
                        </div>
                      </div>
                    </label>
                    <input 
                      type="text" 
                      formControlName="name" 
                      placeholder="e.g., Dell Laptop, Microsoft Office License"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200"
                      [class.border-red-300]="getFieldError('name')"
                      [class.border-green-300]="assetForm.get('name')?.valid && assetForm.get('name')?.touched">
                  @if (getFieldError('name')) {
                      <div class="flex items-center mt-2 text-sm text-red-600">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        {{ getFieldError('name') }}
                      </div>
                  }
                </div>

                  <!-- Serial Number -->
                <div>
                    <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                      Serial Number
                      <span class="text-red-500 ml-1">*</span>
                      <div class="ml-2 group relative">
                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap">
                          Unique identifier for the asset
                        </div>
                      </div>
                    </label>
                    <input 
                      type="text" 
                      formControlName="serialNumber" 
                      placeholder="e.g., ABC123456789"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200"
                      [class.border-red-300]="getFieldError('serialNumber')"
                      [class.border-green-300]="assetForm.get('serialNumber')?.valid && assetForm.get('serialNumber')?.touched">
                  @if (getFieldError('serialNumber')) {
                      <div class="flex items-center mt-2 text-sm text-red-600">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        {{ getFieldError('serialNumber') }}
                      </div>
                  }
                </div>
                </div>

                <!-- Asset Category -->
                <div class="space-y-4">
                  <label class="flex items-center text-sm font-medium text-gray-700">
                    Asset Category
                    <span class="text-red-500 ml-1">*</span>
                    <div class="ml-2 group relative">
                      <svg class="w-4 h-4 text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                      </svg>
                      <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-20">
                        Choose the type of asset
                      </div>
                    </div>
                  </label>
                  
                  <div class="grid grid-cols-2 gap-4">
                    @for (category of ['HARDWARE', 'SOFTWARE']; track category) {
                      <label class="relative flex cursor-pointer rounded-lg border bg-white px-4 py-3 shadow-sm focus:outline-none hover:bg-gray-50 transition-colors duration-200"
                             [class.border-celcom-orange]="assetForm.get('assetCategory')?.value === category"
                             [class.bg-celcom-orange]="assetForm.get('assetCategory')?.value === category"
                             [class.text-white]="assetForm.get('assetCategory')?.value === category">
                        <input type="radio" 
                               formControlName="assetCategory" 
                               [value]="category" 
                               class="sr-only"
                               (change)="updateFieldVisibilityAndValidation(category)">
                        <div class="flex items-center space-x-3 w-full">
                          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            @switch (category) {
                              @case ('HARDWARE') {
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                              }
                              @case ('SOFTWARE') {
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                              }
                            }
                          </svg>
                          <div class="text-left">
                            <div class="font-medium">{{ category | titlecase }}</div>
                            <div class="text-xs opacity-75">
                              @switch (category) {
                                @case ('HARDWARE') { Physical devices }
                                @case ('SOFTWARE') { Applications & licenses }
                              }
                            </div>
                          </div>
                        </div>
                        @if (assetForm.get('assetCategory')?.value === category) {
                          <div class="absolute -top-2 -right-2 flex h-6 w-6 items-center justify-center rounded-full bg-celcom-orange text-white">
                            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                          </div>
                        }
                      </label>
                    }
                  </div>
                  @if (getFieldError('assetCategory')) {
                    <div class="flex items-center text-sm text-red-600">
                      <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                      </svg>
                      {{ getFieldError('assetCategory') }}
                    </div>
                  }
                </div>
              </div>

              <!-- Step 2: Category-Specific Fields -->
              <div class="space-y-6">
                <div class="flex items-center space-x-3 pb-3 border-b border-gray-200">
                  <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                    <span class="text-sm font-medium text-blue-600">2</span>
                  </div>
                <div>
                    <h4 class="text-lg font-medium text-gray-900">
                      {{ assetForm.get('assetCategory')?.value === 'SOFTWARE' ? 'Software Details' : 'Hardware Details' }}
                    </h4>
                    <p class="text-sm text-gray-500">
                      {{ assetForm.get('assetCategory')?.value === 'SOFTWARE' ? 'License and software information' : 'Physical device specifications' }}
                    </p>
                  </div>
                </div>

                <!-- Hardware/Peripheral Fields -->
                @if (showHardwareFields()) {
                  <!-- Hardware Asset Model-Driven Flow -->
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- 🔥 PRIMARY: Asset Model Selection (Hardware) -->
                    <div class="lg:col-span-3">
                      <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                        Asset Model
                        <span class="text-red-500 ml-1">*</span>
                        <div class="ml-2 group relative">
                          <svg class="w-4 h-4 text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                          </svg>
                          <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-20">
                            Select model first - Asset Make and Type will be auto-filled
                          </div>
                        </div>
                      </label>
                      <select 
                        formControlName="modelId" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200"
                        [class.border-red-300]="getFieldError('modelId')"
                        [class.border-green-300]="assetForm.get('modelId')?.valid && assetForm.get('modelId')?.touched"
                        [disabled]="assetModelsLoading()">
                        <option value="">{{ assetModelsLoading() ? 'Loading models...' : 'Select Asset Model' }}</option>
                        @for (model of assetModelsWithDetails(); track model.id) {
                          <option [value]="model.id">{{ model.name }} - {{ model.makeName }} ({{ model.typeName }})</option>
                        }
                      </select>
                      @if (assetModelsLoading()) {
                        <div class="flex items-center mt-2 text-sm text-blue-600">
                          <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                          </svg>
                          Loading models...
                        </div>
                      }
                      @if (getFieldError('modelId')) {
                        <div class="flex items-center mt-2 text-sm text-red-600">
                          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                          </svg>
                          {{ getFieldError('modelId') }}
                        </div>
                      }
                    </div>

                    <!-- 🔥 AUTO-FILLED: Asset Make (Read-only) -->
                    <div>
                      <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                        Asset Make
                        <span class="text-green-500 ml-1">✓</span>
                        <span class="text-xs text-gray-500 ml-1">(Auto-filled)</span>
                      </label>
                      <input 
                        type="text" 
                        [value]="selectedAssetMake()"
                        readonly
                        class="w-full px-4 py-3 border border-gray-200 rounded-lg shadow-sm bg-gray-50 text-gray-600 cursor-not-allowed"
                        placeholder="Will be auto-filled when model is selected">
                      <input type="hidden" formControlName="makeId">
                    </div>

                    <!-- 🔥 AUTO-FILLED: Asset Type (Read-only) -->
                    <div>
                      <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                        Asset Type
                        <span class="text-green-500 ml-1">✓</span>
                        <span class="text-xs text-gray-500 ml-1">(Auto-filled)</span>
                      </label>
                      <input 
                        type="text" 
                        [value]="selectedAssetType()"
                        readonly
                        class="w-full px-4 py-3 border border-gray-200 rounded-lg shadow-sm bg-gray-50 text-gray-600 cursor-not-allowed"
                        placeholder="Will be auto-filled when model is selected">
                      <input type="hidden" formControlName="typeId">
                    </div>

                    <!-- Warranty Expiry -->
                    <div>
                      <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                        Warranty Expiry Date
                        <div class="ml-2 group relative">
                          <svg class="w-4 h-4 text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                          </svg>
                          <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap">
                            When the warranty expires (optional)
                          </div>
                        </div>
                      </label>
                      <input 
                        type="date" 
                        formControlName="warrantyExpiry" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200">
                    </div>
                  </div>
                }

                <!-- Software Fields -->
                @if (showSoftwareFields()) {
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- License Name -->
                    <div>
                      <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                        License Name
                        <span class="text-red-500 ml-1">*</span>
                      </label>
                      <input 
                        type="text" 
                        formControlName="licenseName" 
                        placeholder="e.g., Office 365 Business Premium"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200"
                        [class.border-red-300]="getFieldError('licenseName')"
                        [class.border-green-300]="assetForm.get('licenseName')?.valid && assetForm.get('licenseName')?.touched">
                      @if (getFieldError('licenseName')) {
                        <div class="flex items-center mt-2 text-sm text-red-600">
                          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                          </svg>
                          {{ getFieldError('licenseName') }}
                        </div>
                      }
                    </div>

                    <!-- License Validity Period -->
                    <div>
                      <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                        License Expiry Date
                        <span class="text-red-500 ml-1">*</span>
                      </label>
                      <input 
                        type="date" 
                        formControlName="licenseValidityPeriod" 
                        (change)="onLicenseExpiryDateChange($event)"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200"
                        [class.border-red-300]="getFieldError('licenseValidityPeriod')"
                        [class.border-green-300]="assetForm.get('licenseValidityPeriod')?.valid && assetForm.get('licenseValidityPeriod')?.touched">
                      <!-- License Validity Period Display -->
                      @if (getLicenseValidityMonths() !== null && !getFieldError('licenseValidityPeriod')) {
                        <div class="flex items-center mt-2 text-sm text-celcom-blue">
                          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                          </svg>
                          <span class="font-medium">{{ getLicenseValidityMonths() }} months validity period</span>
                                                     @if (getLicenseValidityMonths() !== null && getLicenseValidityMonths()! < 0) {
                             <span class="ml-2 text-celcom-orange">(Expired date selected)</span>
                           }
                        </div>
                      }
                      
                      @if (getFieldError('licenseValidityPeriod')) {
                        <div class="flex items-center mt-2 text-sm text-red-600">
                          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                          </svg>
                          {{ getFieldError('licenseValidityPeriod') }}
                        </div>
                      }
                    </div>

                  </div>
                }
              </div>

              <!-- 📋 Additional Information Section -->
              <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
                <div class="flex items-center mb-6">
                  <div class="flex items-center justify-center w-8 h-8 bg-gradient-to-r from-celcom-orange to-celcom-purple rounded-full text-white text-sm font-bold mr-3">
                    3
                  </div>
                  <div>
                    <h3 class="text-lg font-semibold text-celcom-blue">Additional Information</h3>
                    <p class="text-sm text-gray-600">
                      Complete asset details and assignment
                    </p>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  <!-- Status -->
                  <div>
                    <label class="text-sm font-medium text-gray-700 mb-2 block">Asset Status</label>
                    <select 
                      formControlName="status" 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200">
                      @for (option of statusDropdownOptions(); track option.value) {
                        <option [value]="option.value">{{ option.label }}</option>
                      }
                    </select>
                  </div>

                  <!-- IT Asset Code -->
                  <div>
                    <label class="text-sm font-medium text-gray-700 mb-2 block">IT Asset Code</label>
                    <input 
                      type="text" 
                      formControlName="itAssetCode" 
                      placeholder="e.g., IT-2024-001"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200">
                  </div>

                  <!-- Inventory Location - Conditional for Software -->
                  @if (showSoftwareFields()) {
                    <div>
                      <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                        Inventory Location
                        <span class="text-xs text-gray-500 ml-1">(Optional)</span>
                        <div class="ml-2 group relative">
                          <svg class="w-4 h-4 text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                          </svg>
                          <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap">
                            Only if software license is tied to physical location
                          </div>
                        </div>
                      </label>
                      <input 
                        type="text" 
                        formControlName="inventoryLocation" 
                        placeholder="e.g., Server Room A, Rack 3"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200">
                    </div>
                  } @else {
                    <!-- Hardware: Show all network fields -->
                    <div>
                      <label class="text-sm font-medium text-gray-700 mb-2 block">Inventory Location</label>
                      <input 
                        type="text" 
                        formControlName="inventoryLocation" 
                        placeholder="e.g., Building A, Floor 3, Room 301"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200">
                    </div>

                    <!-- Operating System - Hardware Only -->
                    <div>
                      <label class="text-sm font-medium text-gray-700 mb-2 block">Operating System</label>
                      <select 
                        formControlName="osId" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200">
                        <option value="">Select Operating System</option>
                        @for (os of operatingSystems(); track os.id) {
                          <option [value]="os.id">{{ os.name }}</option>
                        }
                      </select>
                    </div>

                    <!-- OS Version - Hardware Only -->
                    <div>
                      <label class="text-sm font-medium text-gray-700 mb-2 block">OS Version</label>
                      <select 
                        formControlName="osVersionId" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200"
                        [disabled]="!assetForm.get('osId')?.value">
                        <option value="">{{ !assetForm.get('osId')?.value ? 'Select OS first' : 'Select OS Version' }}</option>
                        @for (version of currentOSVersions(); track version.id) {
                          <option [value]="version.id">{{ version.name }}</option>
                        }
                      </select>
                    </div>

                    <!-- MAC Address - Hardware Only -->
                    <div>
                      <label class="text-sm font-medium text-gray-700 mb-2 block">MAC Address</label>
                      <input 
                        type="text" 
                        formControlName="macAddress" 
                        placeholder="e.g., 00:1B:44:11:3A:B7"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200">
                    </div>

                    <!-- IPv4 Address - Hardware Only -->
                    <div>
                      <label class="text-sm font-medium text-gray-700 mb-2 block">IPv4 Address</label>
                      <input 
                        type="text" 
                        formControlName="ipv4Address" 
                        placeholder="e.g., 192.168.1.100"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200">
                    </div>
                  }
                </div>

                <!-- PO Number - Always Show -->
                <div class="mt-6">
                  <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                    PO Number
                    <div class="ml-2 group relative">
                      <svg class="w-4 h-4 text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                      </svg>
                      <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-20">
                        Select Purchase Order for this asset
                    </div>
                    </div>
                  </label>
                  <select 
                    formControlName="poNumber" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200"
                    [class.border-red-300]="getFieldError('poNumber')"
                    [class.border-green-300]="assetForm.get('poNumber')?.valid && assetForm.get('poNumber')?.touched">
                    <option value="">Select PO Number</option>
                    @for (po of purchaseOrders(); track po.id) {
                      <option [value]="po.poNumber">{{ po.poNumber }} - {{ po.name }}</option>
                    }
                  </select>
                  @if (getFieldError('poNumber')) {
                    <div class="flex items-center mt-2 text-sm text-red-600">
                      <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                      </svg>
                      {{ getFieldError('poNumber') }}
                    </div>
                  }
                </div>

                <!-- Software User Assignment - Software Only -->
                @if (showSoftwareLicenseAssignment()) {
                  <div class="mt-6">
                    <label class="flex items-center text-sm font-medium text-celcom-blue mb-2">
                      Assign Users
                      <div class="ml-2 group relative">
                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-20">
                          Each user consumes one license slot. Max assignable based on license count.
                        </div>
                      </div>
                    </label>

                    <!-- Multi-Select Dropdown Container -->
                    <div class="relative">
                      <div class="w-full min-h-[48px] px-4 py-3 border-2 border-gray-300 rounded-lg shadow-sm focus-within:ring-2 focus-within:ring-celcom-orange focus-within:border-celcom-orange transition-colors duration-200 bg-white"
                           [class.border-gray-400]="!isLicenseUserAssignmentDisabled()"
                           [class.border-gray-200]="isLicenseUserAssignmentDisabled()"
                           [class.bg-gray-50]="isLicenseUserAssignmentDisabled()">
                        
                        <!-- Selected Users Display -->
                        @if (getSelectedLicenseUsers().length > 0) {
                          <div class="flex flex-wrap gap-2 mb-2">
                            @for (user of getSelectedLicenseUsers(); track user.id) {
                              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-celcom-blue/10 text-celcom-blue border border-celcom-blue/20">
                                <span class="mr-1">👤</span>
                                {{ user.name }}
                                <button 
                                  type="button"
                                  (click)="removeLicenseUser(user.id)"
                                  class="ml-2 text-celcom-blue/60 hover:text-celcom-blue transition-colors">
                                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                  </svg>
                                </button>
                              </span>
                            }
                          </div>
                        }

                        <!-- Search Input -->
                        <input 
                          type="text"
                          [(ngModel)]="licenseUserSearchTerm"
                          (input)="onLicenseUserSearch($event)"
                          (focus)="showLicenseUserDropdown.set(true)"
                          (click)="showLicenseUserDropdown.set(true)"
                          [placeholder]="getLicenseUserPlaceholder()"
                          [disabled]="isLicenseUserAssignmentDisabled()"
                          class="w-full border-0 outline-none text-sm bg-transparent disabled:cursor-not-allowed disabled:text-gray-400">
                      </div>

                      <!-- Dropdown Options -->
                      @if (showLicenseUserDropdown() && filteredLicenseUsers().length > 0 && !isLicenseUserAssignmentDisabled()) {
                        <div class="absolute z-30 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                          @for (user of filteredLicenseUsers(); track user.id) {
                            <button 
                              type="button"
                              (click)="selectLicenseUser(user)"
                              [disabled]="isLicenseUserSelected(user.id) || isLicenseAssignmentLimitReached()"
                              class="w-full px-4 py-3 text-left hover:bg-gray-50 focus:bg-gray-50 focus:outline-none transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-3">
                              <span class="text-lg">👤</span>
                              <div class="flex-1">
                                <div class="font-medium text-gray-900">{{ user.name }}</div>
                                <div class="text-sm text-gray-500">{{ user.email }}</div>
                              </div>
                              @if (isLicenseUserSelected(user.id)) {
                                <svg class="w-5 h-5 text-celcom-blue" fill="currentColor" viewBox="0 0 20 20">
                                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                              }
                            </button>
                          }
                        </div>
                      }
                    </div>

                    <!-- Helper Text -->
                    <div class="mt-2 text-sm">
                      @if (getSelectedLicenseUsers().length > 0) {
                        <div class="flex items-center text-celcom-secondary">
                          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                          </svg>
                          Software license users assigned successfully.
                        </div>
                        <div class="mt-1 text-celcom-orange font-medium">
                          {{ getSelectedLicenseUsers().length }} users selected for this software license
                        </div>
                      } @else {
                        <div class="text-gray-500">
                          Search and select users to assign this software license.
                        </div>
                      }
                    </div>
                  </div>
                }

                <!-- User Assignment - Hardware Only -->
                @if (showHardwareFields()) {
                  <div class="mt-6">
                    <label class="flex items-center text-sm font-medium text-gray-700 mb-2">
                      Assign to User
                      <span class="text-red-500 ml-1">*</span>
                      <div class="ml-2 group relative">
                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>
                        <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap">
                          Hardware assets must be assigned to a user
                        </div>
                      </div>
                    </label>
                    <select 
                      formControlName="currentUserId" 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-colors duration-200"
                      [class.border-red-300]="getFieldError('currentUserId')"
                      [class.border-green-300]="assetForm.get('currentUserId')?.valid && assetForm.get('currentUserId')?.touched">
                      <option value="">Select User</option>
                      @for (user of users(); track user.id) {
                        <option [value]="user.id">{{ user.name }} ({{ user.email }})</option>
                      }
                    </select>
                    @if (getFieldError('currentUserId')) {
                      <div class="flex items-center mt-2 text-sm text-red-600">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        {{ getFieldError('currentUserId') }}
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          </form>
                </div>

        <!-- Modal Footer -->
        <div class="sticky bottom-0 bg-white border-t border-gray-200 px-6 py-4">
          <div class="flex items-center justify-between">
            <div class="text-sm text-gray-500">
              @if (!assetForm.valid) {
                <span class="flex items-center">
                  <svg class="w-4 h-4 text-amber-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                  </svg>
                  Please complete all required fields
                </span>
              } @else {
                <span class="flex items-center">
                  <svg class="w-4 h-4 text-green-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                  </svg>
                  Ready to {{ isEditMode() ? 'update' : 'create' }} asset
                </span>
              }
            </div>
            <div class="flex items-center space-x-3">
              <button 
                type="button" 
                (click)="closeAssetModal()" 
                class="px-6 py-3 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors duration-200">
                Cancel
              </button>
              <button 
                type="button"
                (click)="onSubmitAsset()" 
                [disabled]="assetForm.invalid || submissionLoading()"
                class="px-6 py-3 text-sm font-medium text-white bg-celcom-orange rounded-lg hover:bg-celcom-purple focus:outline-none focus:ring-2 focus:ring-celcom-orange focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200 flex items-center space-x-2">
                @if (submissionLoading()) {
                  <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                  <span>{{ isEditMode() ? 'Updating...' : 'Creating...' }}</span>
                } @else {
                  @if (isEditMode()) {
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                  } @else {
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                  }
                  <span>{{ isEditMode() ? 'Update Asset' : 'Create Asset' }}</span>
                }
              </button>
                </div>
          </div>
                </div>
                </div>
                </div>
  }

  <!-- ✅ Status Change Modal -->
  @if (showStatusChangeModal()) {
    <div class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center" (click)="cancelStatusChange()">
      <div class="relative mx-auto p-6 border w-11/12 md:w-1/2 max-w-md shadow-2xl rounded-lg bg-white" (click)="$event.stopPropagation()">
        <div class="mt-3">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-900">Confirm Status Change</h3>
            <button (click)="cancelStatusChange()" class="text-gray-400 hover:text-gray-600 transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
                </div>

          <!-- Info Icon -->
          <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-blue-100 rounded-full">
            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                </div>

          @if (selectedAssetForStatusChange()) {
            <div class="mb-6 text-center">
              <p class="text-lg font-medium text-gray-900 mb-2">Are you sure you want to change status from '{{ getStatusDisplayName(selectedAssetForStatusChange()!.status) }}' to '{{ getStatusDisplayName(pendingStatusChange()) }}'?</p>
              <p class="text-sm text-gray-600 mb-4">This action will be recorded in the asset history.</p>
              <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                <p class="text-sm text-gray-700 mb-2"><strong>Asset:</strong> {{ selectedAssetForStatusChange()!.name }}</p>
                <p class="text-sm text-gray-700 mb-2"><strong>Serial Number:</strong> {{ selectedAssetForStatusChange()!.serialNumber }}</p>
                <p class="text-sm text-gray-700 mb-2"><strong>Current Status:</strong> {{ getStatusDisplayName(selectedAssetForStatusChange()!.status) }}</p>
                <p class="text-sm text-gray-700"><strong>New Status:</strong> {{ getStatusDisplayName(pendingStatusChange()) }}</p>
                </div>
            </div>
          }

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Remarks (Optional)</label>
            <textarea #remarksInput class="w-full border-gray-300 rounded-md shadow-sm focus:ring-celcom-orange focus:border-celcom-orange" rows="3" placeholder="Enter remarks for status change..."></textarea>
          </div>

          <div class="flex justify-center space-x-4">
            <button
              (click)="cancelStatusChange()" 
              class="px-6 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500">
              Cancel
            </button>
            <button
              (click)="confirmStatusChange(remarksInput.value)" 
              [disabled]="statusChangeLoading()"
              class="px-6 py-2 text-sm font-medium text-white bg-celcom-orange rounded-md hover:bg-celcom-purple transition-colors disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-celcom-orange">
              @if (statusChangeLoading()) {
                <div class="flex items-center">
                  <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                  Processing...
                </div>
              } @else {
                Confirm Change
              }
            </button>
          </div>
      </div>
    </div>
  </div>
}

  <!-- ✅ User Assignment Modal -->
  @if (showUserAssignmentModal()) {
    <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" (click)="closeUserAssignmentModal()">
      <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white" (click)="$event.stopPropagation()">
        <div class="mt-3">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900">Assign User to Asset</h3>
            <button (click)="closeUserAssignmentModal()" class="text-gray-400 hover:text-gray-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            </button>
          </div>
          
          @if (selectedAssetForUserAssignment()) {
            <div class="mb-4 p-3 bg-gray-50 rounded-md">
              <p class="text-sm text-gray-600">Asset: <strong>{{ selectedAssetForUserAssignment()!.name }}</strong></p>
              <p class="text-sm text-gray-600">Serial: {{ selectedAssetForUserAssignment()!.serialNumber }}</p>
              <p class="text-sm text-gray-600">Current Status: 
                <span [class]="getStatusColorClass(selectedAssetForUserAssignment()!.status)" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium">
                  {{ getStatusBadge(selectedAssetForUserAssignment()!.status).label }}
                      </span>
                    </p>
              
              <!-- Status-based assignment warnings -->
              @if (!isAssignmentAllowedForStatus(selectedAssetForUserAssignment()!.status)) {
                <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded-md">
                  <div class="flex items-center">
                    <svg class="w-4 h-4 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                    <span class="text-xs text-red-700">Assignment not allowed for {{ selectedAssetForUserAssignment()!.status }} assets</span>
                    </div>
                    </div>
              } @else if (selectedAssetForUserAssignment()!.status === 'In Stock') {
                <div class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded-md">
                  <div class="flex items-center">
                    <svg class="w-4 h-4 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-xs text-blue-700">Assigning a user will automatically change status to "Active"</span>
                  </div>
                </div>
              }
                </div>
              }
              
          <form [formGroup]="userAssignmentForm" (ngSubmit)="handleUserAssignmentSubmit()" class="space-y-4">
            <!-- User Filter Input -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Filter Users</label>
              <div class="relative">
                <input 
                  type="text" 
                  formControlName="userFilter"
                  (input)="onUserAssignmentFilterChange($any($event.target).value)"
                  placeholder="Search by name or email..."
                  class="w-full pl-10 pr-10 border-gray-300 rounded-md shadow-sm focus:ring-celcom-orange focus:border-celcom-orange">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                      </svg>
                    </div>
                @if (userFilter()) {
                  <button 
                    type="button"
                    (click)="clearUserFilter()"
                    class="absolute inset-y-0 right-0 pr-3 flex items-center">
                    <svg class="h-5 w-5 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                }
                    </div>
              @if (userFilter() && filteredUsers().length === 0) {
                <p class="mt-1 text-sm text-gray-500">No users found matching "{{ userFilter() }}"</p>
              } @else if (userFilter()) {
                <p class="mt-1 text-sm text-gray-500">{{ filteredUsers().length }} user{{ filteredUsers().length === 1 ? '' : 's' }} found</p>
              }
                  </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Select User</label>
              <select 
                formControlName="userId" 
                [disabled]="!isAssignmentAllowedForStatus(selectedAssetForUserAssignment()?.status || '') || userAssignmentLoading()"
                class="w-full border-gray-300 rounded-md shadow-sm focus:ring-celcom-orange focus:border-celcom-orange disabled:opacity-50 disabled:cursor-not-allowed">
                <option value="">{{ selectedAssetForUserAssignment()?.currentUserId ? 'Unassign user' : 'Select a user' }}</option>
                @for (user of filteredUsers(); track user.id) {
                  <option [value]="user.id">{{ user.name }} ({{ user.email }})</option>
                }
              </select>
              @if (filteredUsers().length === 0 && !userFilter()) {
                <p class="mt-1 text-sm text-gray-500">No users available for assignment</p>
              }
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Assignment Date</label>
              <input 
                type="date" 
                formControlName="assignmentDate" 
                [disabled]="userAssignmentLoading()"
                class="w-full border-gray-300 rounded-md shadow-sm focus:ring-celcom-orange focus:border-celcom-orange disabled:opacity-50">
        </div>

            <div class="flex justify-end space-x-2 pt-4">
          <button
            type="button"
                (click)="closeUserAssignmentModal()" 
                [disabled]="userAssignmentLoading()"
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                Cancel
              </button>
              <button 
                type="submit" 
                [disabled]="!isAssignmentAllowedForStatus(selectedAssetForUserAssignment()?.status || '') || userAssignmentLoading()"
                class="px-4 py-2 text-sm font-medium text-white bg-celcom-orange rounded-md hover:bg-celcom-purple disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                @if (userAssignmentLoading()) {
                  <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
                  Processing...
            } @else {
                  {{ selectedAssetForUserAssignment()?.currentUserId ? 'Update Assignment' : 'Assign User' }}
            }
          </button>
        </div>
          </form>
      </div>
    </div>
  </div>
}

  <!-- ✅ OLD STATUS HISTORY MODAL REMOVED - Using StatusHistoryModalComponent instead -->

  <!-- ✅ Toast Notification -->
@if (showToast()) {
    <div class="fixed top-4 right-4 z-50">
      <div [class]="'max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 ' + (toastType() === 'success' ? 'border-l-4 border-green-400' : toastType() === 'error' ? 'border-l-4 border-red-400' : 'border-l-4 border-blue-400')">
        <div class="p-4">
          <div class="flex items-start">
            <div class="flex-shrink-0">
          @if (toastType() === 'success') {
                <svg class="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
              } @else if (toastType() === 'error') {
                <svg class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
              } @else {
                <svg class="h-6 w-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          }
        </div>
            <div class="ml-3 w-0 flex-1 pt-0.5">
              <p class="text-sm font-medium text-gray-900">{{ toastMessage() }}</p>
            </div>
            <div class="ml-4 flex-shrink-0 flex">
              <button (click)="hideToast()" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none">
                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
                </div>
                </div>
  }

  <!-- ✅ PO Details Modal -->
  @if (showPODetailsModal()) {
    <div class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center" (click)="showPODetailsModal.set(false)">
      <div class="relative mx-auto p-6 border w-11/12 md:w-1/2 max-w-2xl shadow-2xl rounded-lg bg-white" (click)="$event.stopPropagation()">
        <div class="mt-3">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-900">Purchase Order Details</h3>
            <button (click)="showPODetailsModal.set(false)" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
          </div>

          @if (poDetailsLoading()) {
            <div class="text-center py-12">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-celcom-orange"></div>
              <p class="mt-2 text-sm text-gray-600">Loading PO details...</p>
              </div>
            }

          @if (!poDetailsLoading() && selectedPODetails()) {
            <div class="space-y-6">
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-gradient-to-r from-celcom-orange/5 to-celcom-purple/5 p-4 rounded-lg border">
                  <div class="text-xs text-gray-500 uppercase tracking-wide font-semibold">PO Number</div>
                  <div class="font-bold text-lg text-gray-900">{{ selectedPODetails()!.poNumber }}</div>
              </div>
                <div class="bg-gradient-to-r from-celcom-orange/5 to-celcom-purple/5 p-4 rounded-lg border">
                  <div class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Invoice Number</div>
                  <div class="font-bold text-lg text-gray-900">{{ selectedPODetails()!.invoiceNumber }}</div>
              </div>
                <div class="bg-gray-50 p-4 rounded-lg border">
                  <div class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Acquisition Date</div>
                  <div class="font-medium text-gray-900">{{ selectedPODetails()!.acquisitionDate | date:'mediumDate' }}</div>
            </div>
                <div class="bg-gray-50 p-4 rounded-lg border">
                  <div class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Owner Type</div>
                  <div class="font-medium text-gray-900">{{ selectedPODetails()!.ownerType }}</div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border">
                  <div class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Acquisition Type</div>
                  <div class="font-medium text-gray-900">{{ selectedPODetails()!.acquisitionType }}</div>
              </div>
                <div class="bg-gray-50 p-4 rounded-lg border">
                  <div class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Vendor</div>
                  <div class="font-medium text-gray-900">{{ getname(selectedPODetails()!.vendorId) }}</div>
              </div>
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                  <div class="text-xs text-green-600 uppercase tracking-wide font-semibold">Rental Amount</div>
                  <div class="font-bold text-lg text-green-800">₹{{ selectedPODetails()!.rentalAmount || 0 | number:'1.2-2' }}</div>
          </div>
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                  <div class="text-xs text-green-600 uppercase tracking-wide font-semibold">Acquisition Price</div>
                  <div class="font-bold text-lg text-green-800">₹{{ selectedPODetails()!.acquisitionPrice || 0 | number:'1.2-2' }}</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                  <div class="text-xs text-blue-600 uppercase tracking-wide font-semibold">Current Price</div>
                  <div class="font-bold text-lg text-blue-800">₹{{ selectedPODetails()!.currentPrice || 0 | number:'1.2-2' }}</div>
          </div>
                <div class="bg-gray-50 p-4 rounded-lg border">
                  <div class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Min Contract Period</div>
                  <div class="font-medium text-gray-900">{{ selectedPODetails()!.minContractPeriod || 'N/A' }} months</div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border">
                  <div class="text-xs text-gray-500 uppercase tracking-wide font-semibold">Lease End Date</div>
                  <div class="font-medium text-gray-900">{{ selectedPODetails()!.leaseEndDate | date:'mediumDate' }}</div>
      </div>
    </div>
  </div>
}
              </div>
              </div>
            </div>
  }

  <!-- ✅ Assignment History Modal -->
  @if (showAssignmentHistoryModal()) {
    <div class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center" (click)="showAssignmentHistoryModal.set(false)">
      <div class="relative mx-auto p-6 border w-11/12 md:w-1/2 max-w-2xl shadow-2xl rounded-lg bg-white max-h-[80vh] overflow-y-auto" (click)="$event.stopPropagation()">
        <div class="mt-3">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-900">Assignment History</h3>
            <button (click)="showAssignmentHistoryModal.set(false)" class="text-gray-400 hover:text-gray-600 transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          @if (selectedAssetForAssignmentHistory()) {
            <div class="mb-6 p-4 bg-gradient-to-r from-celcom-orange/10 to-celcom-purple/10 rounded-lg border">
              <p class="text-sm text-gray-600">Asset: <strong class="text-gray-900">{{ selectedAssetForAssignmentHistory()!.name }}</strong></p>
              <p class="text-sm text-gray-600">Serial: <strong class="text-gray-900">{{ selectedAssetForAssignmentHistory()!.serialNumber }}</strong></p>
        </div>
          }

          @if (assignmentHistoryLoading()) {
            <div class="text-center py-12">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-celcom-orange"></div>
              <p class="mt-2 text-sm text-gray-600">Loading assignment history...</p>
            </div>
          }

          @if (!assignmentHistoryLoading() && assignmentHistory().length > 0) {
            <div class="space-y-4">
              <div class="text-sm text-gray-600 mb-4">
                <strong>{{ assignmentHistory().length }}</strong> assignment{{ assignmentHistory().length === 1 ? '' : 's' }} found
              </div>
              
              <!-- Vertical Timeline -->
              <div class="relative">
                <!-- Timeline line -->
                <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gradient-to-b from-celcom-orange to-celcom-purple"></div>
                
                @for (entry of assignmentHistory(); track entry.id; let isLast = $last) {
                  <div class="relative flex items-start space-x-4 pb-8" [class.pb-0]="isLast">
                    <!-- Timeline dot -->
                    <div class="relative z-10 flex items-center justify-center w-8 h-8 bg-gradient-to-r from-celcom-orange to-celcom-purple rounded-full border-4 border-white shadow-lg">
                      <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    
                    <!-- Content -->
                    <div class="flex-1 bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                      <div class="flex items-center justify-between mb-2">
                        <div class="text-sm font-bold text-gray-900">{{ entry.userName }}</div>
                        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">{{ entry.assignedDate | date:'medium' }}</span>
                      </div>
                      @if (entry.remarks) {
                        <p class="text-sm text-gray-700 mt-2 italic bg-gray-50 p-2 rounded border-l-4 border-celcom-orange">"{{ entry.remarks }}"</p>
                  }
                </div>
                </div>
              }
            </div>
            </div>
          }

          @if (!assignmentHistoryLoading() && assignmentHistory().length === 0) {
            <div class="text-center py-12">
              <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
              <p class="text-lg font-medium text-gray-900 mb-2">No Assignment History</p>
              <p class="text-gray-500">This asset has not been assigned to any user yet.</p>
            </div>
                }
              </div>
      </div>
    </div>
  }

  <!-- ✅ NEW: Unassignment Confirmation Modal for Active Status Changes -->
  @if (showUnassignmentConfirmModal()) {
    <div class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full z-50 flex items-center justify-center" (click)="cancelUnassignmentConfirmation()">
      <div class="relative mx-auto p-6 border w-11/12 md:w-1/2 max-w-md shadow-2xl rounded-lg bg-white" (click)="$event.stopPropagation()">
        <div class="mt-3">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-900">Confirm Status Change</h3>
            <button (click)="cancelUnassignmentConfirmation()" class="text-gray-400 hover:text-gray-600 transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
                    </div>

          <!-- Warning Icon -->
          <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-yellow-100 rounded-full">
            <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
                          </svg>
          </div>
          
          @if (pendingUnassignmentAsset()) {
            <div class="mb-6 text-center">
              <p class="text-lg font-medium text-gray-900 mb-2">Changing status from Active will unassign the current user.</p>
              <div class="p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border border-yellow-200">
                <p class="text-sm text-gray-700 mb-2"><strong>Asset:</strong> {{ pendingUnassignmentAsset()!.name }}</p>
                <p class="text-sm text-gray-700 mb-2"><strong>Current Status:</strong> {{ pendingUnassignmentAsset()!.status }}</p>
                <p class="text-sm text-gray-700 mb-2"><strong>New Status:</strong> {{ getStatusDisplayName(pendingUnassignmentStatus()) }}</p>
                <p class="text-sm text-gray-700"><strong>Assigned User:</strong> {{ getUserName(pendingUnassignmentAsset()!.currentUserId) }}</p>
                        </div>
                      </div>
                    }

          <div class="text-center mb-6">
            <p class="text-gray-600">Do you want to proceed with the status change?</p>
          </div>
          
          <div class="flex justify-center space-x-4">
                      <button
              (click)="cancelUnassignmentConfirmation()" 
              class="px-6 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500">
              Cancel
            </button>
            <button 
              (click)="confirmUnassignmentAndStatusChange()" 
              [disabled]="statusChangeLoading()"
              class="px-6 py-2 text-sm font-medium text-white bg-celcom-orange rounded-md hover:bg-celcom-purple transition-colors disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-celcom-orange">
              @if (statusChangeLoading()) {
                          <div class="flex items-center">
                  <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                  Processing...
                          </div>
                        } @else {
                Yes, Proceed
                        }
                      </button>
                    </div>
                  </div>
                </div>
            </div>
  }

  <!-- ✅ PO Selection Modal -->
  @if (showPOSelectionModal()) {
    <div class="fixed inset-0 flex items-center justify-center z-50 bg-black/30 backdrop-blur-sm" (click)="closePOSelectionModal()">
      <div class="relative mx-auto p-6 border w-11/12 md:w-1/2 max-w-lg shadow-2xl rounded-lg bg-white" (click)="$event.stopPropagation()">
        <div class="mt-3">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-900">Select Purchase Order</h3>
            <button (click)="closePOSelectionModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
          </div>
          
          @if (selectedAssetForPO()) {
            <div class="mb-6 p-4 bg-gradient-to-r from-celcom-orange/10 to-celcom-purple/10 rounded-lg border">
              <p class="text-sm text-gray-600">Asset: <strong class="text-gray-900">{{ selectedAssetForPO()!.name }}</strong></p>
              <p class="text-sm text-gray-600">Serial: <strong class="text-gray-900">{{ selectedAssetForPO()!.serialNumber }}</strong></p>
                    </div>
                  }

          <!-- Search/Filter Input -->
          <div class="mb-4">
            <input
              type="text"
              [(ngModel)]="poSearchTerm"
              (input)="filterPONumbers()"
              placeholder="Search PO numbers..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-all duration-200">
            </div>

          <!-- Loading Spinner -->
          @if (poSelectionLoading()) {
            <div class="text-center py-8">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-celcom-orange"></div>
              <p class="mt-2 text-sm text-gray-600">Loading PO numbers...</p>
              </div>
            }

          <!-- PO Dropdown -->
          @if (!poSelectionLoading()) {
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">Select PO Number</label>
              <select
                [(ngModel)]="selectedPONumber"
                (change)="onPOSelectionChange()"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-celcom-orange focus:border-celcom-orange transition-all duration-200">
                <option value="">No PO</option>
                @for (po of filteredPONumbers(); track po.id) {
                  <option [value]="po.poNumber">{{ po.poNumber }}</option>
                }
              </select>
          </div>
          }

          <!-- Debug Information (Development Only) -->
          <div class="mb-4 p-3 bg-gray-50 rounded-lg border text-xs text-gray-600">
            <div class="font-semibold mb-2">Debug Info:</div>
            <div>Selected PO: "{{ selectedPONumber() }}"</div>
            <div>Available POs: {{ filteredPONumbers().length }} / {{ purchaseOrders().length }}</div>
            <div>Loading: {{ poSelectionLoading() }}</div>
          <button
            type="button"
              (click)="debugPOSelectionState()"
              class="mt-2 px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded hover:bg-blue-200">
              Debug Console Log
          </button>
          </div>
          
          <!-- Action Buttons -->
          <div class="flex items-center justify-end space-x-3">
            <button
              type="button"
              (click)="closePOSelectionModal()"
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-celcom-orange focus:ring-offset-2 transition-colors duration-200">
              Cancel
            </button>
            <button
              type="button"
              (click)="confirmPOSelection()"
              [disabled]="poSelectionLoading()"
              class="px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-celcom-orange to-celcom-purple border border-transparent rounded-lg hover:from-celcom-orange/90 hover:to-celcom-purple/90 focus:outline-none focus:ring-2 focus:ring-celcom-orange focus:ring-offset-2 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
              @if (poSelectionLoading()) {
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Updating...
              } @else {
                Confirm
              }
            </button>
        </div>
      </div>
    </div>
  </div>
}

<!-- ✅ Status History Modal -->
<app-status-history-modal
  *ngIf="showStatusHistoryModal()"
  [isVisible]="showStatusHistoryModal()"
  [assetId]="statusHistoryModalAsset()?.id!"
  [assetName]="statusHistoryModalAsset()?.name!"
  [assetSerial]="statusHistoryModalAsset()?.serial!"
  (closeModal)="closeStatusHistoryModal()"
  (modalClosed)="closeStatusHistoryModal()">
</app-status-history-modal>

<!-- ✅ Assignment History Modal -->
<app-assignment-history-modal
  *ngIf="showAssignmentHistoryModal()"
  [isVisible]="showAssignmentHistoryModal()"
  [assetId]="selectedAssetForAssignmentHistory()?.assetId!"
  [assetName]="selectedAssetForAssignmentHistory()?.name!"
  [assetSerial]="selectedAssetForAssignmentHistory()?.serialNumber!"
  (closeModal)="showAssignmentHistoryModal.set(false)"
  (modalClosed)="showAssignmentHistoryModal.set(false)">
</app-assignment-history-modal>

</app-layout>
